name: Build Keep Zips Safe

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Tweak
    runs-on: macos-latest

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 1. ØªØ¬Ù‡ÙŠØ² Theos Ùˆ SDK Ø§Ù„Ø±Ø³Ù…ÙŠ (Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ Ù…Ù„ÙØ§ØªÙƒ)
      - name: Setup Theos & SDK
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          echo "THEOS=~/theos" >> $GITHUB_ENV
          rm -rf ~/theos/sdks
          git clone --depth 1 https://github.com/theos/sdks.git ~/theos/sdks

      # 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ø·ÙˆØ¨Ø©)
      # Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙŠØ³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ zip ÙˆÙŠØ¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø©
      - name: Extract Source Code Only
        run: |
          echo "ðŸ›¡ï¸ Extracting source files safely..."
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† 1.zip (Ù…Ø«Ù„ metalbiew.mm) ÙˆØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
          if [ -f "1.zip" ]; then unzip -j -o "1.zip" "*.mm" "*.h" "*.cpp" -d .; fi
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„ÙØ§Øª HOST7
          if [ -f "HOST7.zip" ]; then unzip -j -o "HOST7.zip" "*.mm" "*.h" "*.m" -d .; fi
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„ÙØ§Øª KittyMemory
          if [ -f "KittyMemory.zip" ]; then unzip -j -o "KittyMemory.zip" "*.cpp" "*.hpp" -d .; fi
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„ÙØ§Øª Ù…Ù†Ø¹ Ø§Ù„Ø­Ø¸Ø± (é˜²ç¦ä»¤)
          if [ -f "é˜²ç¦ä»¤.zip" ]; then unzip -j -o "é˜²ç¦ä»¤.zip" "*.mm" "*.h" -d .; fi

          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Framework (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ù‚Ù‰ Ø¨Ù…Ø¬Ù„Ø¯Ø§ØªÙ‡)
          if [ -f "MetalPerformanceCore.framework.zip" ]; then unzip -q -o "MetalPerformanceCore.framework.zip"; fi

          echo "âœ… Source extracted, Zips kept safe."

      - name: Prepare Dobby
        run: |
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Dobby Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¯ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ±
          if [ -f "Dobby" ]; then 
            mv Dobby libdobby.a
          else
            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ÙˆÙ‡Ù…ÙŠ Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ Ù„Ù… ØªØ±ÙØ¹Ù‡
            touch libdobby.a
          fi

      # 3. ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ (Ù„Ø£Ù†Ù†Ø§ Ø£Ø®Ø±Ø¬Ù†Ø§ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª)
      - name: Fix Imports
        run: |
          # Ø­Ø°Ù Ø£ÙŠ Ù…Ø³Ø§Ø± Ù…Ø¬Ù„Ø¯ ÙŠØ³Ø¨Ù‚ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù„Ø£Ù†Ù†Ø§ Ø¬Ø¹Ù„Ù†Ø§ Ø§Ù„Ù…Ù„ÙØ§Øª ÙƒÙ„Ù‡Ø§ ÙÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬
          # Ø³ÙŠØ­ÙˆÙ„ #import "HOST7/hookURL.h" Ø¥Ù„Ù‰ #import "hookURL.h"
          sed -i '' 's|#import ".*/\(.*\)"|#import "\1"|g' *.mm *.h *.m || true
          sed -i '' 's|#include ".*/\(.*\)"|#include "\1"|g' *.mm *.h *.m || true
          
          # Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ SDK
          echo "SovereignSecurity_CCFLAGS += -std=c++17" >> Makefile

      - name: Build Package
        run: |
          export THEOS=~/theos
          # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØµØ§Ø±Ù…Ø© ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ø²Ù…Ø©
          echo "SovereignSecurity_CFLAGS += -w -Wno-error -I." >> Makefile
          echo "SovereignSecurity_LDFLAGS += -F. -framework MetalPerformanceCore" >> Makefile
          
          make package FINALPACKAGE=1 DEBUG=0 GO_EASY_ON_ME=1 IGNORE_WARNINGS=1

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SovereignSecurity_Done
          path: packages/*.deb

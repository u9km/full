name: Build with User SDK.zip

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Tweak
    runs-on: macos-latest

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 1. Ø¥Ø¹Ø¯Ø§Ø¯ Theos Ùˆ iOS SDK (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­)
      - name: Setup Theos & iOS SDK
        run: |
          # ØªØ­Ù…ÙŠÙ„ Theos
          git clone --recursive https://github.com/theos/theos.git ~/theos
          echo "THEOS=~/theos" >> $GITHUB_ENV
          
          # ØªØ­Ù…ÙŠÙ„ iOS SDK 14.5 (Ø§Ù„Ø±Ø³Ù…ÙŠ)
          rm -rf ~/theos/sdks
          git clone --depth 1 https://github.com/theos/sdks.git ~/theos/sdks
          
          echo "âœ… Environment Ready"

      # 2. ÙÙƒ Ø¶ØºØ· Ù…Ù„Ù SDK.zip Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ lubaiios)
      - name: Extract User SDK.zip
        run: |
          echo "ğŸ” Looking for SDK.zip..."
          
          if [ -f "SDK.zip" ]; then
            echo "ğŸ“¦ Found SDK.zip! Extracting..."
            # ÙÙƒ Ø§Ù„Ø¶ØºØ· ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
            unzip -o -q SDK.zip
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯ ÙÙƒ Ø§Ù„Ø¶ØºØ·
            if [ -f "SDK/lubaiios_Basic.hpp" ]; then
              echo "âœ… Success: Found SDK/lubaiios_Basic.hpp"
            else
              echo "âš ï¸ Warning: Unzipped but specific file not found. Check folder structure inside zip."
              ls -R SDK/ || echo "SDK folder not found"
            fi
          else
            echo "âŒ Error: SDK.zip file not found in the repository!"
            echo "Please upload SDK.zip to the main page."
            exit 1
          fi

      - name: Prepare Dobby
        run: |
          if [ -f "Dobby" ]; then
            mv Dobby libdobby.a
          fi

      # 3. ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ù„ÙƒÙˆØ¯ (Ø£Ù…Ø§Ù† ÙÙ‚Ø·) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
      - name: Fix Imports (Just in case)
        run: |
          # Ø¥Ø²Ø§Ù„Ø© ../ Ù…Ù† metalbiew.h Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
          sed -i 's|\.\./SDK.hpp|SDK.hpp|g' metalbiew.h || true

      - name: Build Package
        run: |
          export THEOS=~/theos
          # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ø²Ù…Ø©
          make package FINALPACKAGE=1 DEBUG=0 IGNORE_WARNINGS=1

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SovereignSecurity_Done
          path: packages/*.deb

name: Build Force Flatten

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Tweak
    runs-on: macos-latest

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 1. ØªØ¬Ù‡ÙŠØ² Theos
      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          echo "THEOS=~/theos" >> $GITHUB_ENV
          rm -rf ~/theos/sdks
          git clone --depth 1 https://github.com/theos/sdks.git ~/theos/sdks

      # 2. ÙÙƒ Ø§Ù„Ø¶ØºØ· ÙˆØ¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª (Ø§Ù„Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„ØªÙƒ)
      - name: Extract and Flatten All Files
        run: |
          echo "ðŸ’¥ Unzipping everything..."
          # ÙÙƒ Ø¶ØºØ· ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ø§Ø³Ù…Ù‡Ø§
          unzip -q -o "*.zip" || true
          
          echo "ðŸšœ Moving all files to root directory..."
          # Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙŠØ¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ù„Ù .mm Ø£Ùˆ .cpp Ø£Ùˆ .h Ø¯Ø§Ø®Ù„ Ø£ÙŠ Ù…Ø¬Ù„Ø¯ ÙˆÙŠØ³Ø­Ø¨Ù‡ Ù„Ù„Ø®Ø§Ø±Ø¬
          find . -type f \( -name "*.mm" -o -name "*.cpp" -o -name "*.m" -o -name "*.h" -o -name "*.hpp" \) -exec mv -f {} . \;
          
          # Ù…Ø³Ø­ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ù„ØªÙ†Ø¸ÙŠÙ
          find . -type d -empty -delete
          
          echo "âœ… All files are now in the main folder."
          ls -F # Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØªØ£ÙƒØ¯

      - name: Prepare Dobby
        run: |
          if [ -f "Dobby" ]; then mv Dobby libdobby.a; fi
          if [ ! -f "libdobby.a" ]; then echo "âš ï¸ Dobby missing but continuing..."; fi

      # 3. Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠÙ‚Ø±Ø£ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶Ù‡Ø§
      - name: Fix Imports
        run: |
          # Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ø³Ø­Ø¨Ù†Ø§ ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ø®Ø§Ø±Ø¬ØŒ ÙŠØ¬Ø¨ Ø­Ø°Ù Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
          # Ù…Ø«Ù„Ø§Ù‹ ÙŠØ­ÙˆÙ„ #import "HOST7/lanjie.h" Ø¥Ù„Ù‰ #import "lanjie.h"
          # ÙˆÙŠØµÙ„Ø­ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©
          sed -i '' 's|#import ".*/|#import "|g' *.mm *.h *.m || true
          sed -i '' 's|#include ".*/|#include "|g' *.mm *.h *.m *.cpp *.hpp || true
          
          # Ø¥ØµÙ„Ø§Ø­ Ø®Ø§Øµ Ù„Ù€ metalbiew.h Ù„ÙŠÙƒÙˆÙ† Ø¨Ø¬Ø§Ù†Ø¨ SDK.hpp
          sed -i '' 's|\.\./SDK.hpp|SDK.hpp|g' metalbiew.h || true

      # 4. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      - name: Build Package
        run: |
          export THEOS=~/theos
          
          # ØªØ¹Ø¯ÙŠÙ„ Makefile Ù„ÙŠÙ‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          echo "SovereignSecurity_CFLAGS += -w -Wno-error -I." >> Makefile
          echo "SovereignSecurity_CCFLAGS += -w -Wno-error -I." >> Makefile
          
          make package FINALPACKAGE=1 DEBUG=0 GO_EASY_ON_ME=1 IGNORE_WARNINGS=1

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SovereignSecurity_Done
          path: packages/*.deb

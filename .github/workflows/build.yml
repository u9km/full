name: Build Fix Arabic Paths

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Tweak
    runs-on: macos-latest

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 1. Ø¥Ø¹Ø¯Ø§Ø¯ Theos
      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          echo "THEOS=~/theos" >> $GITHUB_ENV
          rm -rf ~/theos/sdks
          git clone --depth 1 https://github.com/theos/sdks.git ~/theos/sdks

      # 2. ÙÙƒ Ø§Ù„Ø¶ØºØ·
      - name: Extract Files
        run: |
          if [ -f "SDK.zip" ]; then unzip -o -q SDK.zip; fi
          if [ -f "imgui.zip" ]; then unzip -o -q imgui.zip; fi

      - name: Prepare Dobby
        run: |
          if [ -f "Dobby" ]; then mv Dobby libdobby.a; fi

      # --- 3. Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ---
      - name: Fix Arabic Folder Paths
        run: |
          echo "ðŸ” Searching for UserInfoManager.h..."
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
          FILE_PATH=$(find . -name "UserInfoManager.h" | head -n 1)
          
          if [ -z "$FILE_PATH" ]; then
            echo "âŒ Fatal Error: UserInfoManager.h not found in any folder!"
            exit 1
          else
            DIR_PATH=$(dirname "$FILE_PATH")
            echo "âœ… Found file in: $DIR_PATH"
            
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ø¥Ù„Ù‰ Makefile Ù„ÙƒÙŠ ÙŠØ±Ø§Ù‡ Ø§Ù„ÙƒÙˆÙ…Ø¨Ø§ÙŠÙ„Ø±
            echo "SovereignSecurity_CFLAGS += -I$DIR_PATH" >> Makefile
            echo "SovereignSecurity_CCFLAGS += -I$DIR_PATH" >> Makefile
            
            # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ metalbiew.mm Ù„ÙŠØ­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø·ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¹Ø·ÙˆØ¨
            # Ø³ÙŠØ­ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† "PUBG/Ã¸Â¬Ã¸â„¢/UserInfoManager.h" Ø¥Ù„Ù‰ "UserInfoManager.h" ÙÙ‚Ø·
            echo "ðŸ”§ Patching import path in metalbiew.mm..."
            sed -i '' 's|#import "PUBG/.*.h"|#import "UserInfoManager.h"|g' metalbiew.mm || true
            
            # Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
            sed -i '' 's|\.\./SDK.hpp|SDK.hpp|g' metalbiew.h || true
          fi

      - name: Build Package
        run: |
          export THEOS=~/theos
          # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØµØ§Ø±Ù…Ø© ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ø²Ù…Ø©
          echo "SovereignSecurity_CFLAGS += -w -Wno-error" >> Makefile
          make package FINALPACKAGE=1 DEBUG=0 GO_EASY_ON_ME=1 IGNORE_WARNINGS=1

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SovereignSecurity_Done
          path: packages/*.deb
